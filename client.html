<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CitaDev Control Panel</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; padding: 20px; }
        .card { background: #2a2a2a; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #444; }
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-save { background: #28a745; }
        .btn-update { background: #007bff; margin-bottom: 20px; }
        .sys-info { background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; margin-top: 10px; border: 1px dashed #0f0; }
        input, select { margin: 5px 0; padding: 5px; background: #333; color: white; border: 1px solid #555; display: block; }
        label { font-size: 0.9em; color: #bbb; }
    </style>
</head>
<body>

    <h1>CitaDev Dashboard</h1>
    
    <button class="btn btn-update" onclick="updateGit()">Обновить систему (Git Pull)</button>

    <div id="modules-container">Загрузка модулей...</div>

    <script>
        const API_URL = 'http://localhost:2712/api';

        // Загрузка модулей и отрисовка форм
        async function fetchModules() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const modules = await res.json();
                const container = document.getElementById('modules-container');
                container.innerHTML = '';

                modules.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    let fieldsHtml = `<h3>${m.module}</h3>`;
                    
                    // Чекбокс включения
                    fieldsHtml += `
                        <label>
                            <input type="checkbox" id="enable-${m.module}" ${m.is_active ? 'checked' : ''}> 
                            Включить модуль
                        </label><hr>`;

                    // Генерация полей из схемы
                    for (let key in m.schema) {
                        const field = m.schema[key];
                        const val = m.current_settings[key] || field.default;
                        fieldsHtml += `
                            <label>${field.label}</label>
                            <input type="${field.type}" id="input-${m.module}-${key}" value="${val}">
                        `;
                    }

                    // Если это модуль SystemInfo, добавляем окно вывода
                    if (m.module === 'SystemInfo') {
                        fieldsHtml += `<div class="sys-info" id="sys-info-display">Загрузка данных о железе...</div>`;
                    }

                    fieldsHtml += `
                        <br><button class="btn btn-save" onclick="saveSettings('${m.module}', '${Object.keys(m.schema).join(',')}')">Сохранить</button>
                    `;
                    
                    card.innerHTML = fieldsHtml;
                    container.appendChild(card);
                });
            } catch (e) {
                document.getElementById('modules-container').innerText = 'Ошибка соединения с API (запустите start.bat)';
            }
        }

        // Сохранение
        async function saveSettings(moduleName, keysStr) {
            const keys = keysStr ? keysStr.split(',') : [];
            const settings = { enabled: document.getElementById(`enable-${moduleName}`).checked };
            
            keys.forEach(k => {
                if(k) settings[k] = document.getElementById(`input-${moduleName}-${k}`).value;
            });

            const res = await fetch(`${API_URL}/save`, {
                method: 'POST',
                body: JSON.stringify({ module: moduleName, settings: settings })
            });
            const data = await res.json();
            alert(data.message);
        }

        // Обновление Git
        async function updateGit() {
            if (!confirm('Выполнить обновление и перезагрузить сервер?')) return;
            try {
                const res = await fetch(`${API_URL}/update`);
                const data = await res.json();
                alert(`Git: ${data.output}\n${data.message}`);
            } catch (e) {
                alert('Запрос отправлен. Сервер перезагружается...');
            }
        }

        // Постоянное обновление инфы о системе (раз в 3 сек)
        async function refreshSysInfo() {
            const display = document.getElementById('sys-info-display');
            if (!display) return;
            try {
                const res = await fetch(`${API_URL}/sysinfo`);
                const json = await res.json();
                display.innerText = json.data;
            } catch (e) {}
        }

        fetchModules();
        setInterval(refreshSysInfo, 3000);
    </script>
</body>
</html>