<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CitaDev Control Panel</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; transition: 0.3s; }
        .btn-save { background: #2e7d32; width: 100%; margin-top: 15px; }
        .btn-save:hover { background: #388e3c; }
        .btn-update { background: #1565c0; margin-bottom: 20px; }
        .sys-info { background: #000; color: #00ff41; padding: 15px; font-family: 'Consolas', monospace; white-space: pre-wrap; margin-top: 15px; border-radius: 4px; border: 1px solid #004411; }
        input[type="text"] { width: 100%; padding: 10px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        .module-header { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { font-size: 0.8em; padding: 4px 8px; border-radius: 4px; background: #444; }
        .active { background: #2e7d32; }
    </style>
</head>
<body>

    <h1>CitaDev Dashboard</h1>
    <button class="btn btn-update" onclick="updateGit()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É (Git Pull)</button>

    <div id="modules-container">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π...</div>

    <script>
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ê–î–†–ï–°–ê API
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ localhost -> localhost
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ ZeroTier IP -> ZeroTier IP
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ —Ñ–∞–π–ª -> –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π ZeroTier IP
        const currentHost = window.location.hostname || '10.147.17.129';
        const API_URL = `http://${currentHost}:2712/api`;

        console.log("CitaDev: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API –ø–æ –∞–¥—Ä–µ—Å—É", API_URL);

        async function fetchModules() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const modules = await res.json();
                const container = document.getElementById('modules-container');
                container.innerHTML = '';

                modules.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    let fieldsHtml = `
                        <div class="module-header">
                            <h3>${m.module}</h3>
                            <span class="status-badge ${m.is_active ? 'active' : ''}">${m.is_active ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'}</span>
                        </div>
                        <label>
                            <input type="checkbox" id="enable-${m.module}" ${m.is_active ? 'checked' : ''}> 
                            –í–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å
                        </label><hr style="border:0; border-top:1px solid #333; margin: 15px 0;">`;

                    for (let key in m.schema) {
                        const field = m.schema[key];
                        const val = m.current_settings[key] || field.default;
                        fieldsHtml += `
                            <div style="margin-bottom:10px;">
                                <label style="display:block; margin-bottom:5px; font-size:0.9em; color:#bbb;">${field.label}</label>
                                <input type="${field.type}" id="input-${m.module}-${key}" value="${val}">
                            </div>`;
                    }

                    if (m.module === 'SystemInfo') {
                        fieldsHtml += `<div class="sys-info" id="sys-info-display">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –∂–µ–ª–µ–∑–µ...</div>`;
                    }

                    fieldsHtml += `
                        <button class="btn btn-save" onclick="saveSettings('${m.module}', '${Object.keys(m.schema).join(',')}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    `;
                    
                    card.innerHTML = fieldsHtml;
                    container.appendChild(card);
                });
            } catch (e) {
                document.getElementById('modules-container').innerHTML = `
                    <div class="card" style="border-color: #f44336;">
                        <h3 style="color: #f44336;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è!</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API –ø–æ –∞–¥—Ä–µ—Å—É: <b>${API_URL}</b></p>
                        <p>1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω <b>start.bat</b></p>
                        <p>2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ <b>ZeroTier</b> –ø–æ–¥–∫–ª—é—á–µ–Ω.</p>
                    </div>`;
            }
        }

        async function saveSettings(moduleName, keysStr) {
            const keys = keysStr ? keysStr.split(',') : [];
            const settings = { enabled: document.getElementById(`enable-${moduleName}`).checked };
            
            keys.forEach(k => {
                if(k) settings[k] = document.getElementById(`input-${moduleName}-${k}`).value;
            });

            try {
                const res = await fetch(`${API_URL}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: moduleName, settings: settings })
                });
                const data = await res.json();
                alert(data.message);
                fetchModules(); // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!"); }
        }

        async function updateGit() {
            if (!confirm('–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ GitHub –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
            try {
                const res = await fetch(`${API_URL}/update`);
                const data = await res.json();
                alert(`–û—Ç–≤–µ—Ç Git: ${data.output}\n${data.message}`);
            } catch (e) { alert('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...'); }
        }

        async function refreshSysInfo() {
            const display = document.getElementById('sys-info-display');
            if (!display) return;
            try {
                const res = await fetch(`${API_URL}/sysinfo`);
                const json = await res.json();
                display.innerText = json.data;
            } catch (e) {}
        }

        fetchModules();
        setInterval(refreshSysInfo, 3000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∏–Ω—Ñ—É –æ –∂–µ–ª–µ–∑–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
    </script>
</body>
</html>