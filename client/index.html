<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CitaDev Panel</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; padding: 20px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 25px; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; transition: background 0.3s, transform 0.1s; display: inline-block; }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: #2e7d32; width: 100%; margin-top: 15px; font-size: 16px; }
        .btn-save:hover { background: #388e3c; }
        .btn-update { background: #1565c0; }
        .btn-update:hover { background: #1e88e5; }
        .btn-cfg { background: #424242; }
        .sys-info-title { color: #4caf50; font-weight: bold; margin-bottom: 10px; display: block; }
        .sys-info-box { background: #000; color: #00ff41; padding: 15px; font-family: 'Consolas', 'Courier New', monospace; white-space: pre-wrap; border-radius: 6px; border: 1px solid #004d1a; font-size: 13px; line-height: 1.5; }
        input[type="text"] { width: 100%; padding: 10px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; margin-top: 5px; }
        input[type="text"]:focus { border-color: #90caf9; outline: none; }
        label { font-size: 13px; color: #bbb; }
        h3 { margin-top: 0; color: #90caf9; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .status-bar { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0;">CitaDev Control Panel</h1>
            <div id="status-text" class="status-bar">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...</div>
        </div>
        <div>
            <button class="btn btn-cfg" onclick="changeServerIp()">‚öôÔ∏è –°–º–µ–Ω–∏—Ç—å IP</button>
            <button class="btn btn-update" id="btnUpdate" onclick="updateGit()">üîÑ Git Pull</button>
        </div>
    </div>
    
    <div id="modules-container">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π...</div>

    <script>
        // –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø IP –°–ï–†–í–ï–†–ê
        let currentIp = window.location.hostname;
        if (!currentIp || currentIp === 'localhost' || currentIp === '127.0.0.1') {
            currentIp = localStorage.getItem('citadev_server_ip') || '10.147.17.219';
        }
        const API_URL = `http://${currentIp}:2712/api`;
        document.getElementById('status-text').innerText = `–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: ${API_URL}`;

        // –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–£–õ–ï–ô
        async function fetchModules() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const modules = await response.json();
                const container = document.getElementById('modules-container');
                container.innerHTML = '';

                modules.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    let html = `<h3>${m.module}</h3>`;
                    html += `<label><input type="checkbox" id="chk-${m.module}" ${m.is_active ? 'checked' : ''}> –í–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å</label><br><br>`;

                    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –∏–∑ —Å—Ö–µ–º—ã –º–æ–¥—É–ª—è
                    const keys = [];
                    for (let key in m.schema) {
                        keys.push(key);
                        const field = m.schema[key];
                        const currentVal = m.current_settings[key] || field.default;
                        html += `<div style="margin-bottom:12px;">
                                    <label>${field.label}:</label>
                                    <input type="text" id="input-${m.module}-${key}" value="${currentVal}">
                                 </div>`;
                    }

                    // –ï—Å–ª–∏ —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å, –¥–æ–±–∞–≤–ª—è–µ–º –æ–∫–Ω–æ –≤—ã–≤–æ–¥–∞
                    if (m.module === 'SystemInfo') {
                        html += `<span class="sys-info-title">–î–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:</span>`;
                        html += `<div class="sys-info-box" id="sys-info-display">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>`;
                    }

                    html += `<button class="btn btn-save" onclick="saveModuleSettings('${m.module}', '${keys.join(',')}')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è</button>`;
                    card.innerHTML = html;
                    container.appendChild(card);
                });
            } catch (error) {
                document.getElementById('modules-container').innerHTML = 
                    `<div class="card" style="border-color:#f44336">
                        <h2 style="color:#f44336">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏!</h2>
                        <p>–°–µ—Ä–≤–µ—Ä ${currentIp} –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:</p>
                        <ul>
                            <li>ZeroTier –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ IP –≤–µ—Ä–Ω—ã–π</li>
                            <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–∫—Å–∏ (Squid) –¥–æ–±–∞–≤–ª–µ–Ω –∞–¥—Ä–µ—Å ${currentIp} –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è</li>
                            <li>–ë—Ä–∞–Ω–¥–º–∞—É—ç—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ—Ä—Ç 2712</li>
                        </ul>
                     </div>`;
            }
        }

        // –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö
        async function saveModuleSettings(modName, keysString) {
            const keys = keysString.split(',').filter(k => k !== '');
            const settings = {
                enabled: document.getElementById(`chk-${modName}`).checked
            };
            
            keys.forEach(k => {
                settings[k] = document.getElementById(`input-${modName}-${k}`).value;
            });

            try {
                const response = await fetch(`${API_URL}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: modName, settings: settings })
                });
                const result = await response.json();
                alert(result.message);
                fetchModules();
            } catch (e) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!');
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ß–ï–†–ï–ó GIT
        async function updateGit() {
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ Git?")) return;
            const btn = document.getElementById('btnUpdate');
            btn.disabled = true;
            btn.innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";

            try {
                const res = await fetch(`${API_URL}/update`);
                const data = await res.json();
                alert("–°—Ç–∞—Ç—É—Å: " + data.status + "\n\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n" + data.output);
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.");
            } finally {
                btn.disabled = false;
                btn.innerText = "üîÑ Git Pull";
                location.reload();
            }
        }

        // –°–ú–ï–ù–ê IP
        function changeServerIp() {
            const newIp = prompt("–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ ZeroTier:", currentIp);
            if (newIp) {
                localStorage.setItem('citadev_server_ip', newIp);
                location.reload();
            }
        }

        // –§–û–ù–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–ù–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò
        async function refreshSystemData() {
            const display = document.getElementById('sys-info-display');
            if (!display) return;
            try {
                const res = await fetch(`${API_URL}/sysinfo`);
                const json = await res.json();
                display.innerText = json.data;
            } catch (e) {}
        }

        // –°–¢–ê–†–¢
        fetchModules();
        setInterval(refreshSystemData, 3000);
    </script>
</body>
</html>