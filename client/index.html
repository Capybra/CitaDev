<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CitaDev Control Panel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; margin-right: 10px; }
        .btn-save { background: #2e7d32; width: 100%; margin-top: 15px; }
        .btn-update { background: #1565c0; }
        .btn-cfg { background: #444; }
        .sys-info { background: #000; color: #00ff41; padding: 15px; font-family: monospace; white-space: pre-wrap; margin-top: 15px; border-radius: 4px; }
        input[type="text"] { width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>CitaDev Dashboard</h1>
        <div>
            <button class="btn btn-cfg" onclick="changeServerIp()">‚öôÔ∏è –°–º–µ–Ω–∏—Ç—å IP</button>
            <button class="btn btn-update" onclick="updateGit()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="status-bar" style="margin-bottom: 20px; color: #888;"></div>
    <div id="modules-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <script>
        // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô IP
        let serverIp = window.location.hostname;
        if (!serverIp || serverIp === 'localhost' || serverIp === '127.0.0.1') {
            serverIp = localStorage.getItem('last_known_server_ip') || '10.147.17.129';
        }
        const API_URL = `http://${serverIp}:2712/api`;
        document.getElementById('status-bar').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${API_URL}`;

        async function fetchModules() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const modules = await res.json();
                const container = document.getElementById('modules-container');
                container.innerHTML = '';

                modules.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    let fieldsHtml = `<h3>${m.module}</h3>
                        <label><input type="checkbox" id="enable-${m.module}" ${m.is_active ? 'checked' : ''}> –ê–∫—Ç–∏–≤–µ–Ω</label><br><br>`;

                    for (let key in m.schema) {
                        const field = m.schema[key];
                        const val = m.current_settings[key] || field.default;
                        fieldsHtml += `<label style="font-size:12px;">${field.label}</label>
                                       <input type="text" id="input-${m.module}-${key}" value="${val}"><br><br>`;
                    }

                    if (m.module === 'SystemInfo') fieldsHtml += `<div class="sys-info" id="sys-info-box">–°–±–æ—Ä...</div>`;
                    
                    fieldsHtml += `<button class="btn btn-save" onclick="saveSettings('${m.module}', '${Object.keys(m.schema).join(',')}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
                    card.innerHTML = fieldsHtml;
                    container.appendChild(card);
                });
            } catch (e) {
                document.getElementById('modules-container').innerHTML = `<h2 style="color:red">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å API!</h2>`;
            }
        }

        async function saveSettings(mod, keysStr) {
            const keys = keysStr.split(',');
            const settings = { enabled: document.getElementById(`enable-${mod}`).checked };
            keys.forEach(k => { if(k) settings[k] = document.getElementById(`input-${mod}-${k}`).value; });

            await fetch(`${API_URL}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ module: mod, settings: settings })
            });
            fetchModules();
        }

        function changeServerIp() {
            const ip = prompt("–í–≤–µ–¥–∏—Ç–µ IP —Å–µ—Ä–≤–µ—Ä–∞ ZeroTier:", serverIp);
            if (ip) { localStorage.setItem('last_known_server_ip', ip); location.reload(); }
        }

        async function refreshSys() {
            try {
                const res = await fetch(`${API_URL}/sysinfo`);
                const json = await res.json();
                if(document.getElementById('sys-info-box')) document.getElementById('sys-info-box').innerText = json.data;
            } catch(e){}
        }

        fetchModules();
        setInterval(refreshSys, 3000);
    </script>
</body>
</html>