<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CitaDev Panel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; margin-right: 10px; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }
        .btn-save { background: #2e7d32; width: 100%; margin-top: 15px; }
        .btn-update { background: #1565c0; }
        .btn-cfg { background: #444; }
        .sys-info { background: #000; color: #00ff41; padding: 15px; font-family: monospace; white-space: pre-wrap; margin-top: 15px; border-radius: 4px; border: 1px solid #004d1a; line-height: 1.4; }
        input[type="text"] { width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        h3 { margin-top: 0; color: #90caf9; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>CitaDev Control</h1>
        <div>
            <button class="btn btn-cfg" onclick="changeServerIp()">‚öôÔ∏è IP —Å–µ—Ä–≤–µ—Ä–∞</button>
            <button class="btn btn-update" onclick="updateGit()">üîÑ Git Pull</button>
        </div>
    </div>
    
    <div id="status-bar" style="margin-bottom: 20px; color: #888; font-size: 14px;"></div>
    <div id="modules-container">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π...</div>

    <script>
        // --- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô IP ---
        let serverIp = window.location.hostname;
        if (!serverIp || serverIp === 'localhost' || serverIp === '127.0.0.1') {
            serverIp = localStorage.getItem('last_known_server_ip') || '10.147.17.219';
        }
        const API_URL = `http://${serverIp}:2712/api`;
        document.getElementById('status-bar').innerText = `–ê–∫—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: ${API_URL}`;

        async function fetchModules() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const modules = await res.json();
                const container = document.getElementById('modules-container');
                container.innerHTML = '';

                modules.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    let fieldsHtml = `<h3>${m.module}</h3>
                        <label><input type="checkbox" id="enable-${m.module}" ${m.is_active ? 'checked' : ''}> –ú–æ–¥—É–ª—å –∞–∫—Ç–∏–≤–µ–Ω</label><br><br>`;

                    for (let key in m.schema) {
                        const field = m.schema[key];
                        const val = m.current_settings[key] || field.default;
                        fieldsHtml += `<label style="font-size:12px; color:#bbb;">${field.label}</label><br>
                                       <input type="text" id="input-${m.module}-${key}" value="${val}"><br><br>`;
                    }

                    if (m.module === 'SystemInfo') {
                        fieldsHtml += `<div class="sys-info" id="sys-info-box">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏—Å—Ç–µ–º–µ...</div>`;
                    }
                    
                    fieldsHtml += `<button class="btn btn-save" onclick="saveSettings('${m.module}', '${Object.keys(m.schema).join(',')}')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>`;
                    card.innerHTML = fieldsHtml;
                    container.appendChild(card);
                });
            } catch (e) {
                document.getElementById('modules-container').innerHTML = `<h2 style="color:#ff5252">–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä ${serverIp} –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ZeroTier –∏ –ø—Ä–æ–∫—Å–∏!</h2>`;
            }
        }

        async function saveSettings(mod, keysStr) {
            const keys = keysStr.split(',');
            const settings = { enabled: document.getElementById(`enable-${mod}`).checked };
            keys.forEach(k => { if(k) settings[k] = document.getElementById(`input-${mod}-${k}`).value; });

            try {
                await fetch(`${API_URL}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: mod, settings: settings })
                });
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                fetchModules();
            } catch (e) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!'); }
        }

        async function updateGit() {
            if(!confirm("–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git?")) return;
            const res = await fetch(`${API_URL}/update`);
            const data = await res.json();
            alert(data.message + "\n\n" + data.output);
        }

        function changeServerIp() {
            const ip = prompt("–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ ZeroTier:", serverIp);
            if (ip) { 
                localStorage.setItem('last_known_server_ip', ip); 
                location.reload(); 
            }
        }

        async function refreshSys() {
            const box = document.getElementById('sys-info-box');
            if (!box) return;
            try {
                const res = await fetch(`${API_URL}/sysinfo`);
                const json = await res.json();
                box.innerText = json.data;
            } catch(e) {}
        }

        fetchModules();
        setInterval(refreshSys, 3000);
    </script>
</body>
</html>